<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Khách Hàng - Mall Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .transition-all {
            transition: all 0.3s ease;
        }

        .tab-active {
            border-bottom: 3px solid #1e40af;
            color: #1e40af;
            font-weight: 600;
        }

        [data-content] {
            display: none;
        }

        [data-content].active {
            display: block;
        }

        .reward-card:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #1e40af;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-overlay {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80px;
        }

        .error-message {
            color: #ef4444;
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            font-size: 1.5rem;
            color: #666;
        }
    </style>
</head>

<body class="bg-gray-50 font-sans">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-store text-2xl"></i>
                <h1 class="text-xl font-bold">Customer</h1>
            </div>
            <div class="flex items-center space-x-6">
                <div class="relative group">
                    <button id="notificationBtn" class="flex items-center space-x-2">
                        <i class="fas fa-bell text-xl"></i>
                        <span
                            class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">3</span>
                    </button>
                    <div id="notificationDropdown"
                        class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-50">
                        <div class="p-4 border-b">
                            <h3 class="font-bold text-gray-800">Thông báo (3)</h3>
                        </div>
                        <div class="divide-y divide-gray-200">
                            <a href="#" class="block px-4 py-3 hover:bg-gray-100">
                                <p class="text-sm font-medium text-gray-900">Ưu đãi mới từ Nike</p>
                                <p class="text-xs text-gray-500">2 giờ trước</p>
                            </a>
                            <a href="#" class="block px-4 py-3 hover:bg-gray-100">
                                <p class="text-sm font-medium text-gray-900">Điểm của bạn đã được cập nhật</p>
                                <p class="text-xs text-gray-500">1 ngày trước</p>
                            </a>
                            <a href="#" class="block px-4 py-3 hover:bg-gray-100">
                                <p class="text-sm font-medium text-gray-900">Quà tặng mới đã được thêm vào</p>
                                <p class="text-xs text-gray-500">2 ngày trước</p>
                            </a>
                        </div>
                        <div class="p-2 text-center bg-gray-50">
                            <a href="#" class="text-sm text-blue-600 font-medium">Xem tất cả</a>
                        </div>
                    </div>
                </div>
                <div class="relative group">
                    <button id="profileBtn" class="flex items-center space-x-2">
                        <span class="font-medium" id="customer-name-header">{{user.user_name }}</span>
                    </button>
                    <div id="profileDropdown"
                        class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50">
                        <div class="p-4 border-b">
                            <h3 class="font-bold text-gray-800" id="customer-name-dropdown"></h3>
                            <p class="text-xs text-gray-500" id="customer-tier-dropdown">{{user.membership}}</p>
                        </div>
                        <div class="py-1">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Hồ sơ</a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Cài đặt</a>
                        </div>
                        <div class="py-1 border-t">
                            <a href="/user/logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Đăng
                                xuất</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Customer Info & Points -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div class="mb-4 md:mb-0">
                    <h2 class="text-2xl font-bold mb-2" id="customer-name">Xin chào, {{user.user_name}}!</h2>
                    <p class="text-gray-600" id="customer-tier">Thành viên Bạc - Ưu đãi 5% trên mọi hóa đơn</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4 flex items-center" id="points-container">
                    <div class="bg-blue-100 text-blue-600 p-3 rounded-lg mr-4">
                        <i class="fas fa-coins text-2xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Điểm tích lũy</p>
                        <h3 class="text-2xl font-bold" id="total-points">Đang tải...</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex border-b mb-8">
            <button class="tab-btn px-4 py-2 font-medium text-gray-600 transition-all tab-active"
                data-target="promotions">Ưu đãi</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-600 transition-all" data-target="points">Quản lý
                điểm</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-600 transition-all" data-target="vouchers">Voucher
                của tôi</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-600 transition-all" data-target="history">Lịch sử
                giao dịch</button>
        </div>

        <!-- Promotions Content -->
        <div data-content id="promotions" class="active">
            <h3 class="text-xl font-bold mb-6">Ưu đãi hiện có</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="current-promotions">
                <div class="loading-overlay">
                    <div class="spinner"></div>
                </div>
            </div>
            <h3 class="text-xl font-bold mb-6">Ưu đãi sắp tới</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="upcoming-promotions">
                <div class="loading-overlay">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Points Management Content -->
        <div data-content id="points">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Points Summary -->
                <div class="bg-white rounded-xl shadow-md p-6 transition-all card-hover">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-100 text-blue-600 p-3 rounded-lg mr-4">
                            <i class="fas fa-coins text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500">Điểm hiện có</p>
                            <h3 class="text-2xl font-bold" id="points-summary">Đang tải...</h3>
                        </div>
                    </div>
                    <div class="border-t pt-4">
                        <p class="text-sm text-gray-600"><span class="font-medium">Tỷ lệ quy đổi:</span> 100,000đ = 1
                            điểm</p>
                        <p class="text-sm text-gray-600"><span class="font-medium">Cấp độ:</span> <span
                                id="tier-summary">Đang tải...</span></p>
                    </div>
                </div>

                <!-- Earn Points -->
                <div class="bg-white rounded-xl shadow-md p-6 transition-all card-hover">
                    <h4 class="text-lg font-bold mb-4">Tích điểm</h4>
                    <p class="text-gray-600 text-sm mb-4">Quét mã QR tại cửa hàng để tích điểm sau mỗi lần mua sắm</p>
                    <div class="flex flex-col items-center">
                        <img src="/static/transaction_qr.png" alt="QR Code" class="w-32 h-32 mb-4">
                        <p class="text-xs text-gray-500 mb-2">Mã khách hàng: CUS123456</p>
                        <button
                            class="bg-blue-600 text-white text-sm px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-download mr-2"></i> Tải mã QR
                        </button>
                    </div>
                </div>

                <!-- Redeem Points -->
                <div class="bg-white rounded-xl shadow-md p-6 transition-all card-hover">
                    <h4 class="text-lg font-bold mb-4">Đổi điểm lấy quà</h4>
                    <p class="text-gray-600 text-sm mb-4">Bạn có thể đổi điểm tích lũy để nhận các phần quà hấp dẫn</p>
                    <button class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-all">
                        Xem quà tặng
                    </button>
                </div>
            </div>

            <!-- Reward Catalog -->
            <h3 class="text-xl font-bold mb-6">Quà tặng đổi điểm</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="rewards-catalog">
                <div class="loading-overlay">
                    <div class="spinner"></div>
                </div>
            </div>
            <button
                class="w-full md:w-auto bg-white text-blue-600 border border-blue-600 font-medium py-2 px-6 rounded-lg hover:bg-blue-50 transition-all">
                <i class="fas fa-redo mr-2"></i> Xem thêm quà tặng
            </button>
        </div>

        <!-- Vouchers Content -->
        <div data-content id="vouchers">
            <h3 class="text-xl font-bold mb-6">Voucher của tôi</h3>
            <!-- Brand Vouchers Section -->
            <div class="mb-8">
                <h4 class="text-lg font-bold mb-4">Voucher của Brand</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="brand-vouchers-list">
                    <div class="loading-overlay">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <!-- Mall Vouchers Section -->
            <div>
                <h4 class="text-lg font-bold mb-4">Voucher của Mall</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="mall-vouchers-list">
                    <div class="loading-overlay">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History Content -->
        <div data-content id="history">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <h3 class="text-xl font-bold mb-4 md:mb-0">Lịch sử giao dịch</h3>
                <div class="flex space-x-2">
                    <select id="transactionTypeFilter"
                        class="bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">Tất cả</option>
                        <option value="EARN">Tích điểm</option>
                        <option value="REDEEM">Đổi điểm</option>
                        <option value="PURCHASE">Mua sắm</option>
                    </select>
                    <input type="date" id="transactionDateFilter"
                        class="bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="applyFilterBtn"
                        class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-all">Lọc</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ngày</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Mã giao dịch</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Cửa hàng</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Nội dung</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Điểm</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="transaction-history">
                            <tr>
                                <td colspan="6" class="py-4 px-4 text-center">
                                    <div class="loading-overlay">
                                        <div class="spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-600" id="transaction-count">Hiển thị 0 trên tổng số 0 giao dịch</p>
                <div class="flex space-x-2">
                    <button
                        class="bg-white border border-gray-300 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-50 transition-all">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="bg-blue-600 text-white py-1 px-3 rounded-lg">1</button>
                    <button
                        class="bg-white border border-gray-300 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-50 transition-all">2</button>
                    <button
                        class="bg-white border border-gray-300 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-50 transition-all">3</button>
                    <button
                        class="bg-white border border-gray-300 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-50 transition-all">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Voucher Details Modal -->
        <div id="voucherModal" class="modal">
            <div class="modal-content relative">
                <span class="modal-close" onclick="closeVoucherModal()">×</span>
                <h3 class="text-xl font-bold mb-4" id="voucherModalTitle"></h3>
                <p class="text-gray-600 text-sm mb-2" id="voucherModalDescription"></p>
                <p class="text-sm text-gray-500 mb-2"><span class="font-medium">Mã đổi:</span> <span
                        id="voucherModalCode"></span></p>
                <p class="text-sm text-gray-500 mb-2"><span class="font-medium">Điểm đã dùng:</span> <span
                        id="voucherModalPoints"></span> điểm</p>
                <p class="text-sm text-gray-500 mb-2"><span class="font-medium">Ngày đổi:</span> <span
                        id="voucherModalDate"></span></p>
                <p class="text-sm text-gray-500 mb-2"><span class="font-medium">Nguồn:</span> <span
                        id="voucherModalSource"></span></p>
                <p class="text-sm text-gray-500 mb-4"><span class="font-medium">Trạng thái:</span> <span
                        id="voucherModalStatus"></span></p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 py-8">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h4 class="text-lg font-bold mb-4">Mall Management</h4>
                    <p class="text-gray-600 text-sm">Hệ thống quản lý và tích điểm cho trung tâm thương mại</p>
                </div>
                <div>
                    <h4 class="text-lg font-bold mb-4">Liên hệ</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-600 text-sm hover:text-blue-600 transition-all"><i
                                    class="fas fa-map-marker-alt mr-2"></i> 123 Đường ABC, Quận 1, TP.HCM</a></li>
                        <li><a href="#" class="text-gray-600 text-sm hover:text-blue-600 transition-all"><i
                                    class="fas fa-phone-alt mr-2"></i> 1900 1234</a></li>
                        <li><a href="#" class="text-gray-600 text-sm hover:text-blue-600 transition-all"><i
                                    class="fas fa-envelope mr-2"></i> <span class="__cf_email__"
                                    data-cfemail="93e0e6e3e3fce1e7d3fef2fffffef2fdfe9fef6fef5fabe">[email&#160;protected]</span></a>
                        </li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-bold mb-4">Hỗ trợ</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-600 text-sm hover:text-blue-600 transition-all">Câu hỏi thường
                                gặp</a></li>
                        <li><a href="#" class="text-gray-600 text-sm hover:text-blue-600 transition-all">Hướng dẫn sử
                                dụng</a></li>
                        <li><a href="#" class="text-gray-600 text-sm hover:text-blue-600 transition-all">Chính sách bảo
                                mật</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-bold mb-4">Kết nối với chúng tôi</h4>
                    <div class="flex space-x-4">
                        <a href="#" class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition-all"><i
                                class="fab fa-facebook-f"></i></a>
                        <a href="#" class="bg-pink-600 text-white p-2 rounded-full hover:bg-pink-700 transition-all"><i
                                class="fab fa-instagram"></i></a>
                        <a href="#" class="bg-blue-400 text-white p-2 rounded-full hover:bg-blue-500 transition-all"><i
                                class="fab fa-twitter"></i></a>
                        <a href="#" class="bg-red-600 text-white p-2 rounded-full hover:bg-red-700 transition-all"><i
                                class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-200 mt-8 pt-8 text-center text-gray-500 text-sm">
                <p>© 2025 Mall Management. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script>
        // Configuration
        const USER_ID = 1;
        const BRAND_ID = 1;

        // Utility function to format number
        function formatNumber(number) {
            if (typeof number !== 'number' || isNaN(number)) return '0';
            return number.toLocaleString('vi-VN');
        }

        // Utility function to show messages
        function showMessage(container, message, type = 'error') {
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        // Fetch and render customer info
        async function loadCustomerInfo() {
            const customerName = document.getElementById('customer-name-header').textContent;
            const customerTier = document.getElementById('customer-tier-dropdown').textContent;
            document.getElementById('customer-name').textContent = `Xin chào, ${customerName}!`;
            document.getElementById('customer-tier').textContent = `${customerTier} - Ưu đãi 5% trên mọi hóa đơn`;
            document.getElementById('customer-name-header').textContent = customerName;
            document.getElementById('customer-name-dropdown').textContent = customerName;
            document.getElementById('customer-tier-dropdown').textContent = customerTier;
            document.getElementById('tier-summary').textContent = customerTier;
        }

        // Fetch and render total points
        async function loadTotalPoints() {
            const pointsContainer = document.getElementById('total-points');
            const pointsSummary = document.getElementById('points-summary');
            try {
                const response = await fetch(`/point/get_points/${USER_ID}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Lỗi tải điểm');
                pointsContainer.innerHTML = `${formatNumber(data[0]?.total_points)} <span class="text-lg">điểm</span>`;
                pointsSummary.innerHTML = `${formatNumber(data[0]?.total_points)} <span class="text-lg">điểm</span>`;
            } catch (error) {
                console.error('Error loading total points:', error);
                pointsContainer.innerHTML = '<span class="text-red-500">Lỗi tải</span>';
                pointsSummary.innerHTML = '<span class="text-red-500">Lỗi tải</span>';
            }
        }

        // Fetch and render promotions
        async function loadPromotions() {
            const currentContainer = document.getElementById('current-promotions');
            const upcomingContainer = document.getElementById('upcoming-promotions');
            try {
                const response = await fetch(`/campaign/campaigns?brand_id=${BRAND_ID}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Lỗi tải ưu đãi');

                const current = data.filter(c => c.status === 'Đang hoạt động');
                if (current.length > 0) {
                    currentContainer.innerHTML = current.map(c => `
                        <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all card-hover">
                            <img src="https://placehold.co/600x300/e0e7ff/3730a3?text=${encodeURIComponent(c.title)}" alt="${c.title}" class="w-full h-40 object-cover">
                            <div class="p-6">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="text-lg font-bold">${c.title}</h4>
                                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Đang hoạt động</span>
                                </div>
                                <p class="text-gray-600 text-sm mb-4">${c.description}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500"><i class="fas fa-store-alt mr-1"></i> Brand ${BRAND_ID}</span>
                                    <button class="bg-blue-600 text-white text-sm px-4 py-2 rounded-lg hover:bg-blue-700 transition-all" onclick="redeemCampaign(${c.campaign_id}, ${c.points_required})">
                                        Đổi ngay (${formatNumber(c.points_required)} điểm)
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    currentContainer.innerHTML = '<div class="text-gray-600 text-center col-span-full">Không có ưu đãi hiện tại.</div>';
                }

                const upcoming = data.filter(c => c.status === 'Sắp bắt đầu');
                if (upcoming.length > 0) {
                    upcomingContainer.innerHTML = upcoming.map(c => `
                        <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all card-hover opacity-75">
                            <img src="https://placehold.co/600x300/e0e7ff/3730a3?text=${encodeURIComponent(c.title)}" alt="${c.title}" class="w-full h-40 object-cover">
                            <div class="p-6">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="text-lg font-bold">${c.title}</h4>
                                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Sắp diễn ra</span>
                                </div>
                                <p class="text-gray-600 text-sm mb-4">${c.description}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500"><i class="fas fa-store-alt mr-1"></i> Brand ${BRAND_ID}</span>
                                    <button class="bg-gray-300 text-gray-600 text-sm px-4 py-2 rounded-lg cursor-not-allowed">
                                        Sắp diễn ra
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    upcomingContainer.innerHTML = '<div class="text-gray-600 text-center col-span-full">Không có ưu đãi sắp tới.</div>';
                }
            } catch (error) {
                console.error('Error loading promotions:', error);
                showMessage(currentContainer, `Lỗi tải ưu đãi: ${error.message}`);
                showMessage(upcomingContainer, `Lỗi tải ưu đãi: ${error.message}`);
            }
        }

        // Fetch and render rewards
        async function loadRewards() {
            const rewardsContainer = document.getElementById('rewards-catalog');
            try {
                const response = await fetch(`/voucher/vouchers?brand_id=${BRAND_ID}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Lỗi tải quà tặng');

                if (data.length > 0) {
                    rewardsContainer.innerHTML = data.map(v => `
                        <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all reward-card">
                            <img src="https://placehold.co/600x400/e0e7ff/3730a3?text=${encodeURIComponent(v.title)}" alt="${v.title}" class="w-full h-48 object-cover">
                            <div class="p-6">
                                <h4 class="text-lg font-bold mb-2">${v.title}</h4>
                                <p class="text-gray-600 text-sm mb-4">${v.description}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-600 font-medium">${formatNumber(v.points_required)} điểm</span>
                                    <button class="bg-blue-600 text-white text-sm px-4 py-2 rounded-lg hover:bg-blue-700 transition-all" onclick="redeemVoucher(${v.voucher_id}, ${v.points_required}, '${v.title}')">
                                        Đổi ngay
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    rewardsContainer.innerHTML = '<div class="text-gray-600 text-center col-span-full">Không có quà tặng nào.</div>';
                }
            } catch (error) {
                console.error('Error loading rewards:', error);
                showMessage(rewardsContainer, `Lỗi tải quà tặng: ${error.message}`);
            }
        }

        // Fetch and render brand vouchers
        async function loadUserBrandVouchers() {
            const vouchersContainer = document.getElementById('brand-vouchers-list');
            try {
                const response = await fetch(`/campaign/user_brand_vouchers/${USER_ID}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Lỗi tải voucher');

                if (data.length > 0) {
                    vouchersContainer.innerHTML = data.map(v => `
                        <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all card-hover cursor-pointer" onclick='showVoucherDetails(${JSON.stringify(v)}, "Brand")'>
                            <img src="https://placehold.co/600x400/e0e7ff/3730a3?text=${encodeURIComponent(v.title)}" alt="${v.title}" class="w-full h-48 object-cover">
                            <div class="p-6">
                                <h4 class="text-lg font-bold mb-2">${v.title}</h4>
                                <p class="text-gray-600 text-sm mb-2">${v.description}</p>
                                <p class="text-sm text-gray-500 mb-2"><span class="font-medium">Mã đổi:</span> ${v.redemption_code}</p>
                                <p class="text-sm text-gray-500 mb-4"><span class="font-medium">Điểm đã dùng:</span> ${formatNumber(v.points_required)} điểm</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500"><i class="fas fa-store-alt mr-1"></i> Brand ${BRAND_ID}</span>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${v.status === 'Chưa sử dụng' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${v.status || 'Chưa sử dụng'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    vouchersContainer.innerHTML = '<div class="text-gray-600 text-center col-span-full">Bạn chưa có voucher nào từ Brand.</div>';
                }
            } catch (error) {
                console.error('Error loading brand vouchers:', error);
                showMessage(vouchersContainer, `Lỗi tải voucher: ${error.message}`);
            }
        }

        // Fetch and render mall vouchers
        async function loadUserMallVouchers() {
            const vouchersContainer = document.getElementById('mall-vouchers-list');
            try {
                const response = await fetch(`/voucher/user_mall_vouchers/${USER_ID}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Lỗi tải voucher');

                if (data.length > 0) {
                    vouchersContainer.innerHTML = data.map(v => `
                        <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all card-hover cursor-pointer" onclick='showVoucherDetails(${JSON.stringify(v)}, "Mall")'>
                            <img src="https://placehold.co/600x400/e0e7ff/3730a3?text=${encodeURIComponent(v.title)}" alt="${v.title}" class="w-full h-48 object-cover">
                            <div class="p-6">
                                <h4 class="text-lg font-bold mb-2">${v.title}</h4>
                                <p class="text-gray-600 text-sm mb-2">${v.description}</p>
                                <p class="text-sm text-gray-500 mb-2"><span class="font-medium">Mã đổi:</span> ${v.redemption_code}</p>
                                <p class="text-sm text-gray-500 mb-4"><span class="font-medium">Điểm đã dùng:</span> ${formatNumber(v.points_required)} điểm</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500"><i class="fas fa-store-alt mr-1"></i> Mall</span>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${v.status === 'Chưa sử dụng' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${v.status || 'Chưa sử dụng'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    vouchersContainer.innerHTML = '<div class="text-gray-600 text-center col-span-full">Bạn chưa có voucher nào từ Mall.</div>';
                }
            } catch (error) {
                console.error('Error loading mall vouchers:', error);
                showMessage(vouchersContainer, `Lỗi tải voucher: ${error.message}`);
            }
        }

        // Load all user vouchers
        async function loadUserVouchers() {
            await Promise.all([
                loadUserBrandVouchers(),
                loadUserMallVouchers()
            ]);
        }

        // Show voucher details in modal
        function showVoucherDetails(voucher, source) {
            document.getElementById('voucherModalTitle').textContent = voucher.title;
            document.getElementById('voucherModalDescription').textContent = voucher.description;
            document.getElementById('voucherModalCode').textContent = voucher.redemption_code;
            document.getElementById('voucherModalPoints').textContent = formatNumber(voucher.points_required);
            document.getElementById('voucherModalDate').textContent = new Date(voucher.redeemed_at || voucher.created_at).toLocaleString('vi-VN');
            document.getElementById('voucherModalSource').textContent = source;
            document.getElementById('voucherModalStatus').textContent = voucher.status || 'Chưa sử dụng';
            document.getElementById('voucherModal').style.display = 'flex';
        }

        // Close voucher modal
        function closeVoucherModal() {
            document.getElementById('voucherModal').style.display = 'none';
        }

        // Redeem campaign
        async function redeemCampaign(campaignId, pointsRequired) {
            try {
                const pointsResponse = await fetch(`/point/get_user_points/${USER_ID}`);
                const pointsData = await pointsResponse.json();
                if (!pointsResponse.ok) throw new Error(pointsData.error || 'Lỗi kiểm tra điểm');
                if (pointsData.total_points < pointsRequired) {
                    alert('Bạn không đủ điểm để đổi ưu đãi này.');
                    return;
                }

                const response = await fetch(`/campaign/campaigns/${campaignId}/redeem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: USER_ID })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Lỗi khi đổi ưu đãi');

                await fetch('/point/redeem_points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        campaign_id: campaignId,
                        points_required: pointsRequired,
                        description: `Đổi ưu đãi với mã ${data.redemption_code}`,
                        redemption_code: data.redemption_code
                    })
                });

                alert(`Đổi ưu đãi thành công! Mã đổi: ${data.redemption_code}`);
                loadTotalPoints();
                loadTransactionHistory();
                loadUserBrandVouchers();
            } catch (error) {
                console.error('Error redeeming campaign:', error);
                alert(`Lỗi: ${error.message}`);
            }
        }

        // Redeem voucher
        async function redeemVoucher(voucherId, pointsRequired, voucherTitle) {
            try {
                if (!USER_ID || isNaN(USER_ID)) {
                    throw new Error('USER_ID không hợp lệ hoặc không được định nghĩa!');
                }

                const pointsResponse = await fetch(`/point/get_user_points/${USER_ID}`);
                const pointsData = await pointsResponse.json();
                if (!pointsResponse.ok) throw new Error(pointsData.error || 'Lỗi kiểm tra điểm');
                if (pointsData.total_points < pointsRequired) {
                    alert('Bạn không đủ điểm để đổi quà này.');
                    return;
                }

                const redemptionCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const response = await fetch(`/voucher/vouchers/${voucherId}/redeem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        points_spent: pointsRequired,
                        redemption_code: redemptionCode
                    })
                });

                const responseText = await response.text();
                if (!response.ok) {
                    console.error('Raw response:', responseText);
                    throw new Error(`Lỗi khi đổi quà: ${responseText}`);
                }

                const data = JSON.parse(responseText);

                const redeemPointsResponse = await fetch('/point/redeem_points_by_voucher', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        points_required: pointsRequired,
                        voucher_id: voucherId,
                        description: `Đổi voucher "${voucherTitle}" với mã ${redemptionCode}`,
                        redemption_code: redemptionCode
                    })
                });
                const redeemPointsData = await redeemPointsResponse.json();
                if (!redeemPointsResponse.ok) throw new Error(redeemPointsData.error || 'Lỗi khi trừ điểm');

                alert(`Đổi quà "${voucherTitle}" thành công! Mã đổi: ${redemptionCode}`);
                loadTotalPoints();
                loadTransactionHistory();
                loadUserMallVouchers();
            } catch (error) {
                console.error('Error redeeming voucher:', error);
                alert(`Lỗi: ${error.message}`);
            }
        }

        // Biến toàn cục để lưu trữ danh sách giao dịch gốc
        let allTransactions = [];

        // Fetch and render transaction history
        async function loadTransactionHistory() {
            const historyContainer = document.getElementById('transaction-history');
            try {
                const response = await fetch(`/point/${USER_ID}/transaction_history`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Lỗi tải lịch sử giao dịch');

                allTransactions = data.transactions || [];

                // Hiển thị giao dịch ban đầu (chưa lọc)
                filterTransactions();

            } catch (error) {
                console.error('Error loading transaction history:', error);
                showMessage(historyContainer, `Lỗi tải lịch sử: ${error.message}`);
            }
        }

        // Filter and display transactions based on type and date
        function filterTransactions() {
            const historyContainer = document.getElementById('transaction-history');
            const transactionCount = document.getElementById('transaction-count');
            const typeFilter = document.getElementById('transactionTypeFilter').value;
            const dateFilter = document.getElementById('transactionDateFilter').value;

            // Lọc giao dịch
            let filteredTransactions = allTransactions;

            // Lọc theo loại giao dịch
            if (typeFilter !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => {
                    if (typeFilter === 'EARN') return t.points > 0; // Giả định tích điểm là points > 0
                    if (typeFilter === 'REDEEM') return t.points < 0; // Giả định đổi điểm là points < 0
                    if (typeFilter === 'PURCHASE') return t.description.toLowerCase().includes('mua sắm'); // Giả định giao dịch mua sắm có từ "mua sắm"
                    return true;
                });
            }

            // Lọc theo ngày
            if (dateFilter) {
                const selectedDate = new Date(dateFilter);
                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.toDateString() === selectedDate.toDateString();
                });
            }

            // Hiển thị giao dịch đã lọc
            if (filteredTransactions.length > 0) {
                historyContainer.innerHTML = filteredTransactions.map(t => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(t.date).toLocaleString('vi-VN')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${t.transaction_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.store}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${t.points < 0 ? 'text-red-600' : 'text-green-600'} font-medium">
                            ${t.points < 0 ? '' : '+'}${formatNumber(t.points)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${t.status}</span>
                        </td>
                    </tr>
                `).join('');
            } else {
                historyContainer.innerHTML = '<tr><td colspan="6" class="py-4 px-4 text-center text-gray-600">Không có giao dịch nào.</td></tr>';
            }

            // Cập nhật số lượng giao dịch
            transactionCount.textContent = `Hiển thị ${filteredTransactions.length} trên tổng số ${allTransactions.length} giao dịch`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('tab-active'));
                    document.querySelectorAll('[data-content]').forEach(c => c.classList.remove('active'));
                    btn.classList.add('tab-active');
                    const target = btn.getAttribute('data-target');
                    document.getElementById(target).classList.add('active');
                });
            });

            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const profileBtn = document.getElementById('profileBtn');
            const profileDropdown = document.getElementById('profileDropdown');

            notificationBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationDropdown.classList.toggle('hidden');
            });

            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', () => {
                notificationDropdown.classList.add('hidden');
                profileDropdown.classList.add('hidden');
                closeVoucherModal();
            });

            notificationDropdown.addEventListener('click', (e) => e.stopPropagation());
            profileDropdown.addEventListener('click', (e) => e.stopPropagation());
            document.querySelector('.modal-content').addEventListener('click', (e) => e.stopPropagation());

            // Gắn sự kiện lọc cho phần lịch sử giao dịch
            const applyFilterBtn = document.getElementById('applyFilterBtn');
            applyFilterBtn.addEventListener('click', filterTransactions);
            document.getElementById('transactionTypeFilter').addEventListener('change', filterTransactions);
            document.getElementById('transactionDateFilter').addEventListener('change', filterTransactions);

            Promise.allSettled([
                loadCustomerInfo(),
                loadTotalPoints(),
                loadPromotions(),
                loadRewards(),
                loadUserVouchers(),
                loadTransactionHistory()
            ]).then(results => {
                results.forEach((result, index) => {
                    if (result.status === 'rejected') {
                        console.error(`Load failed for task ${index}:`, result.reason);
                    }
                });
            });
        });
    </script>
</body>

</html>