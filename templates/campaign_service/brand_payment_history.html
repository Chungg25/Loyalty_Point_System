<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Sử Giao Dịch & Thanh Toán</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Point change colors */
        .points-spent {
            color: #dc2626;
        }

        /* red-600 */
        .points-earned {
            color: #16a34a;
        }

        /* green-600 */
        /* Billing Status Badges */
        .status-badge {
            display: inline-block;
            padding: 0.2em 0.6em;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
        }

        .status-paid {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #b45309;
        }

        .status-failed {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .status-unknown {
            background-color: #f3f4f6;
            color: #4b5563;
        }
    </style>
</head>

<body class="bg-gray-100">

    <nav class="bg-gray-800 text-white shadow-md">
        <div class="container mx-auto px-4">
            <div class="flex justify-end items-center h-10 text-sm">
                <span>Xin chào, <span class="font-medium">{{ user_name | default('Brand User') }}</span>!</span>
            </div>
            <div class="flex justify-between items-center h-12 border-t border-gray-700">
                <div class="text-xl font-semibold">Brand Dashboard</div>
                <div class="flex space-x-6">
                    <a href="#" class="hover:text-gray-300 px-3 py-2 rounded-md text-sm font-medium">Xem Thông tin</a>
                    <a href="" class="hover:text-gray-300 px-3 py-2 rounded-md text-sm font-medium">Tạo chiến dịch</a>
                    <a href="" class="hover:text-gray-300 px-3 py-2 rounded-md text-sm font-medium">Danh sách chiến
                        dịch</a>
                    <a href="" class="bg-gray-900 text-white px-3 py-2 rounded-md text-sm font-medium"
                        aria-current="page">Lịch
                        sử Giao dịch</a>
                    <a href="{{ url_for('user.logout') }}"
                        class="hover:text-gray-300 px-3 py-2 rounded-md text-sm font-medium">Đăng Xuất</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-8 p-4 sm:p-6 space-y-8">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg w-full mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Lịch Sử Giao Dịch Điểm</h2>
            <p class="text-sm text-gray-600 mb-6">Các hoạt động tích điểm và đổi quà của khách hàng.</p>
            <div id="pointMessageArea" class="mb-4 text-center text-sm min-h-[40px]"></div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ID Giao Dịch</th>
                            <th scope="col"
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Thời gian</th>
                            <th scope="col"
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Loại</th>
                            <th scope="col"
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Chi tiết</th>
                            <th scope="col"
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ID Khách hàng</th>
                            <th scope="col"
                                class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Điểm +/-</th>
                        </tr>
                    </thead>
                    <tbody id="pointHistoryTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div id="pointEmptyMessage" class="text-center py-6 text-gray-500 hidden">
                Chưa có giao dịch điểm nào.
            </div>
        </div>

        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg w-full mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Lịch Sử Thanh Toán</h2>
            <p class="text-sm text-gray-600 mb-6">Các hóa đơn và thanh toán phí dịch vụ.</p>
            <div id="billingMessageArea" class="mb-4 text-center text-sm min-h-[40px]"></div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ID Hóa Đơn</th>
                            <th scope="col"
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ngày Lập</th>
                            <th scope="col"
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Mô tả</th>
                            <th scope="col"
                                class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Số Tiền (VNĐ)</th>
                            <th scope="col"
                                class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Trạng thái</th>

                        </tr>
                    </thead>
                    <tbody id="billingTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div id="billingEmptyMessage" class="text-center py-6 text-gray-500 hidden">
                Chưa có lịch sử thanh toán nào.
            </div>
        </div>

    </div>

    <script>
        // Get elements for Point History
        const pointTableBody = document.getElementById('pointHistoryTableBody');
        const pointMessageArea = document.getElementById('pointMessageArea');
        const pointEmptyMessage = document.getElementById('pointEmptyMessage');

        // Get elements for Billing History
        const billingTableBody = document.getElementById('billingTableBody');
        const billingMessageArea = document.getElementById('billingMessageArea');
        const billingEmptyMessage = document.getElementById('billingEmptyMessage');

        // --- Helper Functions (Keep all helpers: formatDateTime, formatDate, formatCurrency, formatPoints, getPointTransactionTypeDisplay, getBillingStatusInfo) ---
        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return 'Invalid Date';
                const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                return date.toLocaleString('vi-VN', options).replace(',', '');
            } catch (e) { return 'Invalid Date'; }
        }
        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return 'Invalid Date';
                const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                return date.toLocaleDateString('vi-VN', options);
            } catch (e) { return 'Invalid Date'; }
        }
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '-';
            const numberFormat = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
            return numberFormat.format(amount);
        }
        function formatPoints(points) {
            if (points === null || points === undefined) return '-';
            return points > 0 ? `+${points}` : (points === 0 ? '0' : points);
        }
        function getPointTransactionTypeDisplay(type) {
            const typeMap = { 'REDEEM_REWARD': { text: 'Đổi quà', class: 'points-spent' }, 'EARN_POINTS': { text: 'Tích điểm', class: 'points-earned' } };
            return typeMap[type] || { text: type || 'Không rõ', class: '' };
        }


        // --- Load Point History ---
        async function loadPointHistory() {
            pointMessageArea.innerHTML = '<div class="loader"></div><p class="text-sm text-gray-500">Đang tải lịch sử điểm...</p>';
            pointTableBody.innerHTML = '';
            pointEmptyMessage.classList.add('hidden');

            try {
                // *** FETCH FROM POINT HISTORY API ENDPOINT ***
                const response = await fetch('/campaign/brand_point_history_data'); // <<< ADJUST URL AS NEEDED

                if (!response.ok) { /* ... (Error handling including 401 redirect) ... */
                    let errorMsg = `Lỗi ${response.status}`; try { const ed = await response.json(); errorMsg = `Lỗi ${response.status}: ${ed.error || 'Không thể tải'}`; if (response.status === 401) window.location.href = "{{ url_for('user.login_page') }}"; } catch (e) { } throw new Error(errorMsg);
                }

                const pointHistory = await response.json();
                pointMessageArea.innerHTML = ''; // Clear loading

                if (pointHistory && pointHistory.length > 0) {
                    pointHistory.forEach(item => {
                        const typeInfo = getPointTransactionTypeDisplay(item.transaction_type);
                        const pointsDisplay = formatPoints(item.points_change);
                        const pointsClass = item.points_change > 0 ? 'points-earned' : (item.points_change < 0 ? 'points-spent' : '');
                        const row = `
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-gray-500">${item.id || 'N/A'}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDateTime(item.timestamp)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${typeInfo.class}">${typeInfo.text}</td>
                                <td class="px-4 py-3 text-sm text-gray-700">${item.description || 'N/A'}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${item.customer_id || '-'}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-right ${pointsClass}">${pointsDisplay}</td>
                            </tr>`;
                        pointTableBody.innerHTML += row;
                    });
                } else {
                    pointEmptyMessage.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Failed to load point history:', error);
                pointMessageArea.innerHTML = `<p class="text-red-600 font-medium">Lỗi tải lịch sử điểm: ${error.message}</p>`;
            }
        }

        // --- Load Billing History ---
        async function loadBillingHistory() {
            billingMessageArea.innerHTML = '<div class="loader"></div><p class="text-sm text-gray-500">Đang tải lịch sử thanh toán...</p>';
            billingTableBody.innerHTML = '';
            billingEmptyMessage.classList.add('hidden');

            try {
                // *** FETCH FROM BILLING HISTORY API ENDPOINT ***
                const response = await fetch('/transaction/brand_billing_history'); // <<< ADJUST URL AS NEEDED

                if (!response.ok) { /* ... (Error handling including 401 redirect) ... */
                    let errorMsg = `Lỗi ${response.status}`; try { const ed = await response.json(); errorMsg = `Lỗi ${response.status}: ${ed.error || 'Không thể tải'}`; if (response.status === 401) window.location.href = "{{ url_for('user.login_page') }}"; } catch (e) { } throw new Error(errorMsg);
                }

                const billingHistory = await response.json();
                billingMessageArea.innerHTML = ''; // Clear loading

                if (billingHistory && billingHistory.length > 0) {
                    billingHistory.forEach(item => {
                        const row = `
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-gray-500">${item.id || 'N/A'}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDate(item.timestamp)}</td>
                                <td class="px-4 py-3 text-sm text-gray-700">${item.description || 'N/A'}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium text-right">${formatCurrency(item.amount)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-center text-sm">
                                    <span class="status-badge ">Đã thanh toán</span>
                                </td>
                            </tr>`;
                        billingTableBody.innerHTML += row;
                    });
                } else {
                    billingEmptyMessage.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Failed to load billing history:', error);
                billingMessageArea.innerHTML = `<p class="text-red-600 font-medium">Lỗi tải lịch sử thanh toán: ${error.message}</p>`;
            }
        }

        // Load both histories when the page is ready
        document.addEventListener('DOMContentLoaded', () => {
            loadPointHistory();
            loadBillingHistory();
        });
    </script>

</body>

</html>